[TOC]



---

协议逆向工程(Protocol Reverse Engineering)，是指在不依赖于协议描述的情况下，通过对协议实体的网络输入/输出、系统行为和指令执行流程进行监控和分析，提取协议语法、语义和同步信息的过程，是工程化的协议逆向分析方法。





# Introduction



# Principles of Protocol Design

> 协议设计原理



**TPDU**,全称Transport Protocol Data Unit，是指传送协议数据单元。代表从一个传输实体发送至另一个传输实体的消息



## 协议模型

- 将n层对等实体间为实现该层协议所交换的信息单元称为协议数据单元(Protocol Data Unit, PDU)
- PDU通常由两部分组成：
  - 1. 用户数据
    2. 协议控制信息(Protocol Control Information, PCI). PCI一般作为首部加在用户数据的前面，但有时也可作为尾部加在用户数据的后面，例如用于差错检测的检验和(checksum)常放在尾部
- 根据PDU中是否携带用户数据，可将其分为两类：
  - 1. 数据PDU。SDU(Service Data Unit, 服务数据单元)就是数据PDU中的用户数据
    2. 控制PDU: 不携带用户数据
- 不同协议层次中，PDU有不同称呼：物理层比特bit，数据链路层帧frame信元cell，网络层分组 包packet，运输层以上 报文message



- 服务访问点(Service Accessing Point, SAP)： 同一系统中相邻两层的实体进行交互（交换信息）之处。上层访问下层所提供服务的点
- 服务原语(Service Primitives): 再进行交互时所要交换的一些必需信息(或命令),以表明需要本地或远端的对等实体做哪些事情

OSI规定每一层均可使用四种服务原语：

| 服务原语类型 | 译名 | 意义                                 |
| ------------ | ---- | ------------------------------------ |
| Request      | 请求 | 一个实体希望得到某种服务             |
| Indication   | 指示 | 把关于某一事件的信息告诉某一实体     |
| Response     | 响应 | 一个实体愿意响应某一事件             |
| Confirm      | 证实 | 把一个实体的服务请求加以确认并告诉它 |

SDU(Service Data Unit, 服务数据单元)就是数据PDU中的用户数据，但不一定是一一对应关系。多个SDU合成为一个PDU为拼装，一个SDU划分为几个PDU为分段

协议是水平的，是控制对等实体之间通信的规则。服务是垂直的，服务是由下层向上层通过层间接口提供的。只有能够被高一层看见的功能才能称为服务。

服务原语：上层使用下层所提供的服务必须通过与下层交换一些命令，这些命令再OSI中称为服务原语。

某一层向上一层提供的服务实际上包括了在它以下各层所提供的服务。



## 协议设计的基本内容



### 协议的通信环境

n层协议的通信环境：用户要求，(n-1)层通道的性质，n层协议运行时的操作系统和硬件环境。

通道类别：

1. 空通道empty channels: 报文的发送时间和延时时间为0的通道，即任何时刻通道中不容纳报文
2. 非缓冲通道 non-buffered channels: 再任何时刻，最多只有一个正在传送中的报文的通道
3. 缓冲通道 buffered channels: 允许有多个报文停留的通道

n-1层通道的性质对n层协议的构成有非常重要的影响，主要包括(p17)：

1. 通道的队列性质
2. 回程延时(Round Trip Time, RTT): 报文从n层源端实体发出到该报文的应答信息达到该实体之间的时间。包含目标实体收到报文后对报文进行处理，然后发出认可信息的时间。是协议最重要的参数之一。
3. 通道的差错特性。主要包括：报文的出错率、丢失率、重复率、失序率
4. 通道的可靠性。指通道故障，如断连、复位
5. 报文的最大长度。
6. 通道的工作方式。单工、半双工、全双工。同步、异步。全双工可以视为两个分离的单工通道。
7. 通道的带宽(bandwidth)。通道上能够传送的数字信号的速率，即数据率、比特率。可进一步分为前向带宽、后向带宽、峰值带宽



### 协议提供的服务

1. 面向连接的 connection-oriented. 有连接建立、数据传输、连接释放，3阶段。
2. 无连接的 connectionless. 无连接服务有以下三种类型：
   1. 数据报 datagram. 不需要接收端做任何响应，是一种不可靠的服务。“尽最大努力交付”(best effort delivery)
   2. 证实交付 confirmed delivery. 又称可靠的数据报。对每一个报文产生一个证实confirm给发端用户，confirm来自提供服务的层，而不是接收端用户。这种confirm只能保证报文已经发给远端目的站了，不能保证目的站用户已收到这个报文。
   3. 请求回答 request-reply. 收端用户每收到一个报文，就向发端用户发送一个应答报文。事务transaction中的一问一答方式的短报文以及数据库中的查询，很适合使用这种类型的服务。

### 协议功能

> p19

1. 连接管理
2. 差错控制
3. 流量控制
4. 拥塞控制
5. 无活动控制
6. 通信量控制
7. 通信量填充。产生虚假的(n)SDU以防止通信量分析
8. 通信量整形。
9. 路由选择
10. 带外数据或紧急数据的发送和接受
11. 安全控制



### 协议元素

第一章介绍了，从语言的角度看，协议包括三个要素：语法、语义、同步。

从协议的组成来看，协议一般由以下6种元素构成：

1. 服务原语和服务原语时序
2. 协议数据单元PDU和PDU交换时序
3. 协议状态
4. 协议事件
5. 协议变量
6. 协议操作和谓词



#### 服务原语和服务原语时序

一个完整的服务原语通常包括1. 原语名字; 2. 原语类型; 3. 原语参数





#### 协议事件

按事件的用途，可将协议事件分为输入事件和输出事件。

1. 输入事件：1. 收到一个PDU 2.收到n层服务用户的一条服务原语 3. 内部事件(如计时器超时)
2. 输出事件：1. 发出一个PDU 2. 向n层服务用户发出一条服务原语

根据时间的作用范围，可将事件分为

1. 通信事件。分为
   1. 同步事件。输入事件和输出事件发生在同一个事件点上，同时出现，也称为协同事件。
   2. 异步事件。输入事件和输出事件发生在两个事件点上，不同时出现，输出事件滞后输入事件
2. 内部事件。如计时器超时。不是成对出现的。





#### 协议操作和谓词

协议过程是指协议再一定条件下，在输入事件的驱动下，执行一系列的操作、动作。包括：

1. 产生输出事件
2. 清除和设置计时器
3. 修改协议变量
4. 改变协议状态

协议操作只在一定条件下才能够被执行。这些约束条件涉及协议参数、协议变量、协议运行环境等

谓词predicate: 描述这些约束条件的语句称为谓词





## 差错控制技术

1. 硬件途径：选用高可靠性的设备和传输媒体(e.g.光纤)及相应的辅助措施(e.g. 屏蔽)来提高传输的可靠性
2. 软件途径：通过差错控制编码(包括检错码和前向纠错码)实现的差错检测、肯定确认、超时重传、否认重传、选择重传等措施来实现差错控制。



### 报文丢失、重复、失序处理技术

> p38

1. 肯定确认
2. 否定确认
3. 选择确认



1. 独立确认。用一个确认PDU来携带确认信息
2. 应答携带piggy-backing。将确认信息放在数据PDU中发送



TCP协议设置了四个计时器：

1. 重传计时器
2. 坚持计时器
3. 保活计时器
4. 时间等待计时器



#### 重传

> p41，详情见Computer_Networ.md

发送者重传由确认所指出的数据PDU或重传计时器超时时重传未收到确认的数据PDU。主要有两种基于滑动窗口的重传方法

1. 回退n帧 Go-back-N
2. 选择重传 selective repeat





## 典型协议



### HDLC协议

> 属于数据链路层协议

- High-level Data Link Control 高级数据链路控制。国际标准ISO 3309
- HDLC可适用于链路的两种基本配置，即非平衡配置和平衡配置



- 标志字段F(Flag)。`01111110` 六个连续的1，两边各加一个0，作为标志字段。`0x7E`
- HDLC使用零比特填充法使帧中两个F字段之间不会出现6个连续的1。发送端只要发现有5个连续1，则立即填入一个0。接收端每当发现5个连续1，就将其后的一个0删除，即可还原成原来的比特流。采用零比特填充法可传送任意组合的比特流，或者说，可实现数据链路层的透明传输。故两个F字段之间叫透明传输区间。





### PPP协议

> 属于数据链路层协议

- 点对点协议PPP(Point-to-Point Protocol)
- 当PPP用在同步传输链路时，采用硬件来完成比特填充(与HDLC做法一样)
- 当PPP用在异步传输时，使用一种特殊的字符填充法:
  - `0x7E` to `0x7E 0x5E`
  - `0x7D` to `0x7D 0x5D`
  - ASCII码的控制字符(数值小于`0x20`的字符)，则在该字符前面加入一个`0x7D`字节，同时将该字符的编码加以改变，例如`0x03`要变为`0x31`。目的时防止这些表面上的ASCII码控制符被错误地解释为控制符



p51描述了PPP协议与LCP、NCP协议的互动过程



### IP协议

> 目前分为两个版本 IPv4 IPv6

p53详细描述了IP数据报的格式





### TCP协议

> 传输层协议

P57详细解释了TCP连接的三次握手的详细过程



### HTTP协议

> 因特网应用最广泛的应用层协议

- 面向事务的客户服务器协议
- 虽然HTTP使用了TCP，但HTTP是无状态的stateless. 每一个事务都是独立地进行处理，当一个事务开始时，就在万维网客户与服务器之间产生一个TCp连接。当事务结束时就释放这个TCP连接。
- HTTP协议本身是无连接的，但是使用了面向连接的TCP向上提供的服务

p58说明了HTTP请求报文的格式



# Description Model of Protocol Specification

> 协议规范描述模型 《网络协议逆向分析及应用》Chap 3 p61



